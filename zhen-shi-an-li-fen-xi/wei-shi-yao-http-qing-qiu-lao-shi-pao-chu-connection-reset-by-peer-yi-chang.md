### httpè¯·æ±‚ä¸ºå•¥è€æ˜¯æŠ›å‡ºç½‘ç»œå¼‚å¸¸

**é—®é¢˜æè¿°ï¼š**

> **æœ€è¿‘ä¸šåŠ¡ç›‘æ§ç¾¤é‡Œï¼Œè€æ˜¯æŠ›å‡ºä¸€äº›java.net.SocketExceptionï¼šConnection resetçš„å¼‚å¸¸ã€‚        **
>
> 1. **éƒ¨åˆ†è¯·æ±‚å¼‚å¸¸**
> 2. **éƒ¨åˆ†httpè¯·æ±‚æ­£å¸¸è¿”å›**

**æ•…éšœç»“è®ºï¼š**

> **ç¬¬ä¸€ååº”ï¼Œå°±æ˜¯å…¨è¿æ¥æˆ–è€…åŠè¿æ¥é˜Ÿåˆ—è®¾ç½®ä¸åˆç†ï¼Œå¹¶å‘å¤ªé«˜å¯¼è‡´çš„è¿æ¥è¢«ä¸¢å¼ƒï¼Œå®é™…å»æŸ¥çœ‹æœºå™¨æƒ…å†µæ—¶ï¼Œçš„ç¡®å‘ç°ç«¯å£å¯¹åº”çš„tcpè¿æ¥çš„å…¨è¿æ¥é˜Ÿåˆ—ä¸€ç›´æ˜¯æ»¡çš„ï¼Œæœ€åå‘ç°åŸå› çš„ç¡®æ˜¯å…¨è¿æ¥é˜Ÿåˆ—æ»¡äº†ï¼Œå¤„ç†ä¸äº†tcp è¿æ¥è¯·æ±‚ï¼Œå¯¼è‡´httpè¯·æ±‚è¢«resetæ‰ï¼Œæ ¹æœ¬åŸå› ä¸æ˜¯å¹¶å‘é«˜ï¼Œä¹Ÿä¸æ˜¯è¿æ¥é˜Ÿåˆ—å¤ªå°äº†ï¼Œè€Œæ˜¯ç¨‹åºfullgcå¯¼è‡´tomcatå¡æ­»äº†ï¼Œè¿æ¥å¤„ç†ä¸äº†ï¼Œæ‰€ä»¥è¡¨ç°å‡ºæ¥çš„å°±æ˜¯è¿æ¥é˜Ÿåˆ—æ»¡äº†ã€‚ã€‚è¿™åˆæ˜¯ä¸€ä¸ªä¼¤å¿ƒçš„æ•…äº‹ã€‚ğŸ˜“    ğŸ˜“    ğŸ˜“  **

**åŸå› åˆ†æ:**

é‚£ä¹ˆä¸ºä»€ä¹ˆhttpè¯·æ±‚ä¼šæŠ›å‡ºè¿™ä¸ªç½‘ç»œå¼‚å¸¸ï¼Œè¿™ä¸ªå¾—å…ˆä»ä¼ è¯´ä¸­çš„TCP ä¸‰æ¬¡æ¡æ‰‹å¼€å§‹ï¼Œå…ˆç›—ä¸ªå›¾ï¼Œè¿™å¼ å›¾ç”»çš„å¾ˆå¥½ã€‚

![](/assets/tcp_sync_ack.png)

è¿™ä¸ªå›¾è¯¦ç»†æ ‡å‡ºäº†tcpè¿æ¥è¿‡ç¨‹ä¸­ï¼Œè¿æ¥çš„çŠ¶æ€å˜åŒ–ã€‚ä¸€ä¸ªæ­£å¸¸çš„è¿æ¥è¯·æ±‚ï¼Œåº”è¯¥æ˜¯ç±»ä¼¼è¿™æ ·çš„:![](/assets/wireshark_tcp_connect_state.png)

* step1: clientå‘é€synåŒ…åˆ°serverè¿›è¡Œæ¡æ‰‹
* step2: serveræ”¶åˆ°synåï¼Œè¿”å›syn+ackç»™client
* step3: clientæ”¶åˆ°syn+ackä¹‹åï¼Œå›å¤ç»™serverä¸€ä¸ªackè¡¨ç¤ºæ”¶åˆ°äº†syn+ackï¼Œè‡³æ­¤clientä¹Ÿå˜æˆestablishedçŠ¶æ€ï¼Œè¿æ¥å»ºç«‹æˆåŠŸ

ç°åœ¨æˆ‘ä»¬æ¥çœ‹çœ‹å½“æ—¶ç²—çº¿æ•…éšœæ—¶ï¼ŒæœåŠ¡å™¨ä¸Šçš„æŠ“åŒ…æƒ…å†µï¼š![](/assets/tcp_reset_server.png)

å¯¹ç…§TCPä¸‰æ¬¡æ¡æ‰‹çš„æƒ…å†µåˆ†æï¼Œä»æŠ“åŒ…çœ‹step1å’Œstep2å®Œæˆï¼Œçœ‹èµ·æ¥å»ºç«‹è¿æ¥çš„è¿‡ç¨‹ä¸­step3ä¸­clientä¹Ÿå‘å‡ºå»äº†ackåŒ…äº†ï¼Œè‡³æ­¤è¿æ¥åº”è¯¥å»ºç«‹äº†ï¼Œä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¹ˆå¤šTCPåŒ…å‘é€å¤±è´¥çš„æƒ…å†µå‘¢ï¼Ÿ

å…¶å®ä¸ç„¶ï¼Œå¯¹ç…§TCPä¸‰æ¬¡æ¡æ‰‹çš„æµç¨‹å›¾ï¼Œé‡Œé¢æœ‰ä¸¤ä¸ªå¾ˆé‡è¦çš„é˜Ÿåˆ—ï¼Œå¯¹äºç½‘ç»œå¼€å‘ç»éªŒå°‘çš„äººæ¥è¯´ï¼Œç»å¸¸æ€§ä¼šå¿½ç•¥ï¼Œè¿™ä¸¤ä¸ªé˜Ÿåˆ—å½±å“ç€TCPè¿æ¥çš„æˆåŠŸï¼Œç°åœ¨æˆ‘å®Œæ•´æè¿°ä¸€ä¸‹TCPè¿æ¥å»ºç«‹çš„è¿‡ç¨‹ï¼ˆç©¿æ’ä¸¤ä¸ªè¿æ¥é˜Ÿåˆ—çš„ä½œç”¨ï¼‰

* clientç«¯å‘èµ·SYNè¯·æ±‚ï¼Œè¯·æ±‚å»ºç«‹è¿æ¥,clientè¿›å…¥SYN\_SENDçŠ¶æ€ï¼Œserverç«¯æ”¶åˆ°SYNè¯·æ±‚ï¼Œ

* è¿æ¥è¿›å…¥SYN\_RECVçŠ¶æ€ï¼Œæ­¤æ—¶ä¼šåˆ›å»ºä¸€ä¸ªè¿æ¥ä¿¡æ¯å­˜å‚¨åœ¨**syns queue**é˜Ÿåˆ—é‡Œï¼Œç„¶åå›å¤syn+ackåˆ°client

* clientæ”¶åˆ°server å›å¤çš„syn+ackåï¼Œå›å¤ackç»™serverç«¯ï¼Œclientè¿›å»establishedçŠ¶æ€ï¼Œ**æ­¤æ—¶å®¢æˆ·ç«¯å¯èƒ½ä¼šè¿›è¡Œæ•°æ®å‘é€** ,serverç«¯æ”¶åˆ°clientçš„ackåï¼Œserverä¼šåˆ é™¤syns queueé˜Ÿåˆ—ä¸­çš„è¿æ¥ä¿¡æ¯ï¼Œç„¶åè¿›å…¥åˆ°ä¸€ä¸ªå«åš**accept queue**é˜Ÿåˆ—

æµç¨‹ä¸­ï¼Œå¦‚æœsyns queueå’Œaccept queueæ»¡ï¼Œéƒ½å¯èƒ½å¯¼è‡´è¿æ¥å¼‚å¸¸ï¼Œå…·ä½“æƒ…å†µå–å†³äºç³»ç»Ÿå‚æ•°ã€‚

case 1ï¼šå¦‚æœåŠè¿æ¥é˜Ÿåˆ—æ»¡äº†ï¼Œåœ¨é˜¶æ®µ2å°±ä¼šå‡ºé—®é¢˜ï¼Œå¯¼è‡´æ­£å¸¸è¯·æ±‚çš„SYNåŒ…å°±æ²¡æœ‰åŠæ³•æ­£å¸¸å¤„ç†ï¼Œä¸æ˜¯æˆ‘ä»¬é‡åˆ°çš„æƒ…å†µ

case2ï¼š å¦‚æœè¿æ¥é˜Ÿåˆ—æ»¡äº†ï¼ŒæœåŠ¡ç«¯ä¼šæŒ‰ç…§ç½‘ç»œå‚æ•°net.ipv4.tcp\_abort\_on\_overflowçš„å€¼è¿›è¡Œå¤„ç†ï¼Œå¦‚æœtcp\_abort\_on\_overflow=0ï¼Œåˆ™ä¸¢å¼ƒæ‰clientçš„ackåŒ…ï¼Œä¸ä½œå¤„ç†ï¼ŒæœåŠ¡ç«¯è¿‡ä¸€æ®µæ—¶é—´åä¼šé‡æ–°å‘é€syn+ackçš„åŒ…ï¼ŒæŒ‰ç…§é‡ä¼ æœºåˆ¶ï¼Œæ‰§è¡Œnet.ipv4.tcp\_synack\_retriesæ¬¡é‡ä¼ ï¼Œæ¯æ¬¡é‡ä¼ é—´éš”æ—¶é—´doubleï¼Œæœ€ç»ˆå¤±è´¥åï¼Œæ‰§è¡Œresetï¼›å½“ç„¶è¿™é‡Œå¦‚æœclientè¶…æ—¶æ—¶é—´è¾ƒçŸ­çš„è¯ï¼Œå°±ä¼šæŠ›å‡ºè¿æ¥è¶…æ—¶connection timeoutä¹‹ç±»çš„å¼‚å¸¸ã€‚



OKï¼Œé€šè¿‡ä¸Šé¢çš„åˆ†æï¼Œå¯¹ç…§ç€æˆ‘ä»¬çš„æŠ“åŒ…ï¼Œå‘ç°æƒ…å†µï¼Œå°±æ˜¯case2çš„æƒ…å†µï¼Œå»æœåŠ¡å™¨ä¸Šæ‰§è¡Œsysctl -aæŸ¥çœ‹ç³»ç»Ÿçš„tcpå‚æ•°ã€‚

```
net.ipv4.tcp_abort_on_overflow = 0
net.ipv4.tcp_max_syn_backlog = 2048
net.ipv4.tcp_syn_retries = 3
net.ipv4.tcp_synack_retries = 5
net.ipv4.tcp_syncookies = 1
```

å‘ç°æœç„¶tcp\_abort\_on\_overflow=0ï¼Œtcp\_synack\_retries é‡ä¼ æ¬¡æ•°æ˜¯5æ¬¡ï¼Œç»è¿‡63ç§’åï¼Œè¿æ¥è¢«resetã€‚

> **notice:**
>
> 1. **åŠè¿æ¥é˜Ÿåˆ—çš„å¤§å°ï¼Œå–å†³äºç³»ç»Ÿnet.ipv4.tcp\_max\_syn\_backlogå˜é‡**
> 2. **å…¨è¿æ¥é˜Ÿåˆ—çš„å¤§å°ï¼Œå–å†³äºå®šä¹‰socketæ—¶ï¼ŒListenä¼ é€’çš„backlogçš„å¤§å°ï¼Œå’Œå†…æ ¸å‚æ•°net.core.somaxconnçš„è¾ƒå°å€¼ï¼Œå³min\(backlog,somaxconn\)çš„å€¼**
>
> **æˆ‘ä»¬å†™ä»£ç çš„æ—¶å€™ï¼Œåº”è¯¥æœ‰å¾ˆå¤šäººä»æ¥æ²¡æœ‰æƒ³è¿‡è¿™ä¸ªbacklogï¼Œç›´æ¥å¿½è§†äº†å®ƒ**



ä¸Šé¢æ˜¯æˆ‘æœ€å–œæ¬¢çš„æŠ“åŒ…åˆ†ææ³•ï¼Œå¯¹äºtcpdumpå’Œwiresharkä¸ç†Ÿæ‚‰çš„åŒäº‹ï¼Œä¹Ÿæœ‰å…¶ä»–ç®€å•çš„æ–¹æ³•æ¥å®šä½è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯æ²¡æœ‰æŠ“åŒ…åˆ†ææ³•è¿™ä¹ˆå‡†ç¡®ã€‚



**å¿«é€Ÿå®šä½æ³•ï¼š**

> ä½¿ç”¨æ›´å¸¸ç”¨çš„å·¥å…·å®šä½ï¼Œnetstatå’Œsså‘½ä»¤å®šä½é—®é¢˜ã€‚





